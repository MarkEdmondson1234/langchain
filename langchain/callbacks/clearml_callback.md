The code defines several utility functions and a class called `BaseMetadataCallbackHandler` that handles metadata and associated function states for callbacks. The functions include `import_spacy`, `import_pandas`, `import_textstat`, `_flatten_dict`, `flatten_dict`, `hash_string`, and `load_json`. These functions are used to import necessary packages, flatten dictionaries, hash strings, and load JSON files. The class has several attributes that keep track of the number of times certain methods have been called, as well as several lists that store records of method calls. The class also has several properties that return boolean values indicating whether certain types of callbacks should be ignored or always verbose. The `ignore_agent` property returns a boolean indicating whether to ignore agent callbacks, while the `get_custom_callback_meta` method returns a dictionary of metadata for the callback handler, and the `reset_callback_meta` method resets the metadata for the callback handler. Additionally, the code includes a function called `import_clearml` that imports the `clearml` package and raises an error if it is not installed.

The code defines a callback handler class called `ClearMLCallbackHandler` that logs to ClearML. The class takes in several parameters such as job type, project name, and tags, and utilizes associated callback methods to format input with metadata regarding the state of LLM run. The class then adds the response to the list of records for both the {method}_records and action, and logs the response to the ClearML console. The class includes methods such as `_init_resp`, `on_llm_start`, and `on_llm_new_token`. The `_init_resp` method initializes the response dictionary, while `on_llm_start` runs when LLM starts and `on_llm_new_token` runs when LLM generates a new token. Both methods update the response dictionary with relevant metadata and add the response to the list of records.

The code defines several callback functions for different stages of a language model (LLM) run, including `on_llm_new_token`, `on_llm_end`, `on_llm_error`, `on_chain_start`, `on_chain_end`, and `on_tool_start`. These functions update a response dictionary with relevant metadata and add the response to a list of records. The `on_llm_new_token` function updates the response dictionary with a new token generated by the LLM, while the `on_llm_end` function updates the response dictionary with the LLM output and analyzes the text. The `on_chain_start` function updates the response dictionary with serialized input and starts a chain, while the `on_chain_end` function updates the response dictionary with chain outputs. The `on_tool_start` function updates the response dictionary with serialized input and starts a tool. All functions utilize the `_init_resp` method to initialize the response dictionary and the `get_custom_callback_meta` method to get custom metadata for the callback handler. If `stream_logs` is True, the response is logged to the ClearML console.

The code defines several callback functions for different stages of a language model (LLM) run, including `on_tool_start`, `on_tool_end`, `on_tool_error`, `on_text`, `on_agent_finish`, `on_agent_action`, and `analyze_text`. These functions update a response dictionary with relevant metadata and add the response to a list of records. The `on_tool_start` function updates the response dictionary with serialized input and starts a tool, while the `on_tool_end` function updates the response dictionary with tool output. The `on_text` function updates the response dictionary with text, while the `on_agent_finish` function updates the response dictionary with agent output and log. The `on_agent_action` function updates the response dictionary with tool information and log. The `analyze_text` function analyzes text using textstat and spacy. All functions utilize the `_init_resp` method to initialize the response dictionary and the `get_custom_callback_meta` method to get custom metadata for the callback handler. If `stream_logs` is True, the response is logged to the ClearML console.

The code defines several callback functions for different stages of a language model (LLM) run, including `on_tool_start`, `on_tool_end`, `on_tool_error`, `on_text`, `on_agent_finish`, `on_agent_action`, and `analyze_text`. These functions update a response dictionary with relevant metadata and add the response to a list of records. The `on_tool_start` function updates the response dictionary with serialized input and starts a tool, while the `on_tool_end` function updates the response dictionary with tool output. The `on_text` function updates the response dictionary with text, while the `on_agent_finish` function updates the response dictionary with agent output and log. The `on_agent_action` function updates the response dictionary with tool information and log. The `analyze_text` function analyzes text using textstat and spacy. All functions utilize the `_init_resp` method to initialize the response dictionary and the `get_custom_callback_meta` method to get custom metadata for the callback handler. If `stream_logs` is True, the response is logged to the ClearML console.

The code defines several callback functions for different stages of a language model (LLM) run, including `on_tool_start`, `on_tool_end`, `on_tool_error`, `on_text`, `on_agent_finish`, `on_agent_action`, and `analyze_text`. These functions update a response dictionary with relevant metadata and add the response to a list of records. The `on_tool_start` function updates the response dictionary with serialized input and starts a tool, while the `on_tool_end` function updates the response dictionary with tool output. The `on_text` function updates the response dictionary with text, while the `on_agent_finish` function updates the response dictionary with agent output and log. The `on_agent_action` function updates the response dictionary with tool information and log. The `analyze_text` function analyzes text using textstat and spacy. All functions utilize the `_init_resp` method to initialize the response dictionary and the `get_custom_callback_meta` method to get custom metadata for the callback handler. If `stream_logs` is True, the response is logged to the ClearML console. 

The `llm_outputs_df` function creates a dataframe with information from the LLM run. The `session_analysis_df` function concatenates the `llm_input_prompts_df` and `llm_outputs_df` dataframes. The `flush_tracker` function flushes the tracker and sets up the session. It logs the action records and session analysis, and saves the langchain asset if provided. It also cleans up after adding everything to ClearML and closes the task if `finish` is True.

